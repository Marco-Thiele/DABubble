<!--Main chat-head channel-->
<div class="head-member-container" *ngIf="isChannelVisible && selectedChannel">
  <div
    class="head-title-channel"
    (click)="editChannel(selectedChannel)"
    [style.background-color]="
      isEditChannelOpen() ? 'var(--Bg-color, #eceefe)' : 'initial'
    "
  >
    <div class="title-channel">
      <div class="title-hashtag">
        <div
          class="hashtag"
          [style.background-image]="
            isEditChannelOpen()
              ? 'url(/assets/icons/tag_blue.svg)'
              : 'url(/assets/icons/tag.svg)'
          "
        ></div>
        <span
          class="title font700-normal"
          [style.color]="isEditChannelOpen() ? '#535af1' : 'initial'"
          >{{ selectedChannel.name }}</span
        >
        <div class="head-arrow-cont">
          <div
            [style.background-image]="
              isEditChannelOpen()
                ? 'url(/assets/icons/keyboard_arrow_down_blue.svg)'
                : 'url(/assets/icons/keyboard_arrow_down.svg)'
            "
          ></div>
        </div>
      </div>
    </div>
  </div>

  <div class="members-add-container">
    <div class="members-cont" (click)="showMembers()">
      <div class="members" *ngFor="let member of selectedChannel.members">
        <img [src]="member.imgProfil || member.profileImg" />
      </div>
    </div>
    <span class="font600-normal">{{ selectedChannel.members.length }}</span>
    <div class="add-member-cont" (click)="addMembers()">
      <div></div>
    </div>
  </div>
</div>

<!--Main chat-head new chat-->
<div
  class="head-new-message-cont"
  *ngIf="isNewMessageVisible && showContainers"
>
  <div class="head-new-message-title">
    <span class="font700-normal">Neue Nachricht</span>
  </div>
  <div class="head-new-message-searchbar" [class.focused]="isFocused">
    <input
      type="text"
      placeholder="An: #channel, oder @jemand oder E-Mail Adresse"
      (focus)="inputFocused()"
      (blur)="inputBlurred()"
      (input)="searchMembersAndChannels($event)"
      [(ngModel)]="inputValue"
    />
  </div>
</div>

<div
  class="head-new-direct-message-cont"
  *ngIf="isChatWithMemberVisible || (isPrivateChatVisible && currentChatData)"
>
  <div class="head-new-direct-message">
    <div class="new-direct-message-img">
      <div class="head-photo">
        <img src="{{ selectedMember.profileImg }}" />
        <div class="online"></div>
      </div>
    </div>
    <span class="font700-normal">{{ selectedMember.name }}</span>
  </div>
</div>

<div class="chat-container">
  <div
    class="inner-container"
    *ngIf="
      (isChannelVisible && selectedChannel) ||
      isNewMessageVisible ||
      (isChatWithMemberVisible && selectedMember && currentChatData) ||
      (isPrivateChatVisible && selectedMember && currentChatData)
    "
    #chatContainer
    (scroll)="handleScroll($event)"
  >
    <!--Main chat principal-->
    <div *ngIf="isNewMessageVisible">
      <div
        *ngIf="showContainers && inputValue"
        class="container-lookingfor"
        #membersContainer
      >
        <div *ngIf="memberMatches.length > 0" class="searchMatches">
          <span class="font600-normal">Members gefunden:</span>
          <div *ngFor="let member of memberMatches">
            <div class="memberMatches" (click)="openPrivateContainer(member)">
              <img [src]="member.profileImg" alt="" />
              <span>{{ member.name }}</span>
            </div>
          </div>
        </div>
        <div *ngIf="channelMatches.length > 0" class="searchMatches">
          <span class="font600-normal">Channels gefunden:</span>
          <div *ngFor="let channel of channelMatches">
            <div class="channelMatches" (click)="openChannel(channel)">
              <img src="/assets/icons/tag.svg" alt="" />
              <span class="font400-normal">{{ channel.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--Text for the beginning of creating a channel.-->
    <div class="beginning-chat-cont" *ngIf="isChannelVisible">
      <div class="title-hashtag">
        <div class="hashtag"></div>
        <span class="title font700-normal">{{ selectedChannel.name }}</span>
      </div>
      <div class="beginning-description">
        <span class="font400-normal descrip-text"
          >Du hast diesen Channel heute erstellt. Das ist der Anfang des
          Channels
          <span class="font400-normal"
            ><a style="font-size: 22px">#</a>&nbsp;<a>Office-team</a>.</span
          >
        </span>
      </div>
    </div>

    <!--Container to write private messages-->

    <!-- <div class="privat-chat-container" *ngIf="isPrivatChatContainerVisible"> -->
    <div
      class="beginning-private-chat"
      *ngIf="isChatWithMemberVisible && currentChatData && selectedMember"
    >
      <div class="private-chat-member" *ngFor="let selectedMember">
        <div class="private-message-img">
          <div
            class="img"
            [style.background-image]="'url(' + selectedMember.imgProfil + ')'"
          ></div>
        </div>
        <a class="font700-normal">{{ selectedMember.name }} </a>
      </div>
      <div
        class="description-private-msg"
        *ngIf="isChatWithMemberVisible && currentChatData && selectedMember"
      >
        <span class="font400-normal"
          >Diese Unterhaltung findet nur zwischen
          <a class="font400-normal">@{{ selectedMember.name }} &nbsp;</a>und dir
          statt.</span
        >
      </div>
      <div class="private-chat-user" *ngIf="isPrivateChatVisible">
        <div class="private-message-img">
          <div
            class="img"
            [style.background-image]="'url(' + selectedMember.imgProfil + ')'"
          ></div>
        </div>
        <a class="font700-normal">{{ selectedMember.name }}</a>
      </div>
      <div class="description-private-msg-user" *ngIf="isPrivateChatVisible">
        <span class="font700-normal"
          >Dieser Raum ist nur für dich da.
          <a class="font400-normal"
            >mache dir Notizen, liste deine To-dos auf oder bewahre Links und
            Dateien griffbereit auf. Du kannst hier auch gerne Dinge mit dir
            selbst besprechen.</a
          ></span
        >
      </div>
    </div>

    <!--Time-line-->
    <!-- <div *ngFor="let group of groupedMessagesArray"> -->
    <div
      *ngFor="
        let message of ((selectedMember && currentChatData?.chat) || []).concat(
          selectedChannel?.chat || []
        );
        let i = index
      "
    >
      <ng-container
        *ngIf="i === 0 || parseDate(message.date) !== parseDate(previousDate)"
      >
        <div
          *ngIf="i === 0 || parseDate(message.date) !== parseDate(previousDate)"
        >
          <div class="time-separator">
            <div class="time-line"></div>
            <div class="time-day">
              <span class="font400-normal">{{
                parseDate(message.date) | date : "EEEE, d MMMM"
              }}</span>
            </div>
          </div>
          {{ updatePreviousDate(message.date) }}
        </div>
      </ng-container>
      <!--Container for the member's chat-->
      <div
        [ngClass]="{
          'message-user-box-cont': message.userName == userService.getName()
        }"
        class="message-members-box-cont"
      >
        <div
          [ngClass]="{
            'message-reaction-people-reverse':
              message.userName == userService.getName()
          }"
          class="message-reaction-people"
        >
          <div class="reaction-icon">
            <div class="icon-tick"></div>
          </div>
          <div class="reaction-icon">
            <div class="icon-hands"></div>
          </div>
          <div class="reaction-icon" (click)="toggleEmojiPicker(i)">
            <div class="icon-smile"></div>
          </div>
          <div class="reaction-icon">
            <div class="icon-message"></div>
          </div>
          <div
            [ngClass]="{
              'reaction-icon': message.userName == userService.getName()
            }"
          >
            <div
              [ngClass]="{
                'icon-points': message.userName == userService.getName()
              }"
              (click)="toggleShowEdit(i)"
            >
              <div
                class="delete-message"
                *ngIf="showEdit[i]"
                (click)="editMessage(i, message.id)"
              >
                Nachricht bearbeiten
              </div>
            </div>
          </div>
        </div>
        <div class="message-user-img">
          <div
            [style.background-image]="'url(' + message.profileImg + ')'"
          ></div>
        </div>
        <div
          [ngClass]="{
            'message-members-box-reverse':
              message.userName == userService.getName()
          }"
          class="message-members-box"
          *ngIf="!editMessageUser[i]"
        >
          <div
            [ngClass]="{
              'message-user-name-reverse':
                message.userName == userService.getName()
            }"
            class="message-user-name"
          >
            <a
              class="name"
              (click)="
                showUserProfil(
                  message.userName,
                  message.profileImg,
                  message.email,
                  message.uid
                )
              "
              >{{ message.userName }}</a
            >
            <span class="font400-normal">{{ message.time }}</span>
          </div>
          <div
            [ngClass]="{
              'message-members-speech-reverse':
                message.userName == userService.getName()
            }"
            class="message-members-speech"
          >
            <span class="font400-normal" (click)="openThread(i, message.id)">{{
              message.text
            }}</span>
            <img
              src="{{ message.imageUrl }}"
              alt=""
              [style.width]="message.imageUrl ? '150px' : '0px'"
              [style.margin-top]="message.imageUrl ? '8px' : '0px'"
            />
          </div>
          <div class="message-user-reaction">
            <div>
              <div class="answer-icons">
                <div
                  *ngFor="
                    let emojis of (selectedChannel
                      ? selectedChannel.chat
                      : currentChatData.chat)[i].reactions;
                    let j = index
                  "
                  class="answer-reaction"
                  (click)="deleteEmoji(i, j)"
                >
                  <div class="info-emojis" *ngIf="emojis">
                    <div class="info-emoji">{{ emojis.emoji }}</div>
                    <div class="info-emojis-name">
                      <span
                        *ngFor="let userName of emojis.users; let isLast = last"
                      >
                        {{ userName }}
                        <ng-container *ngIf="!isLast">, </ng-container>
                      </span>
                    </div>
                    <div>
                      {{
                        emojis?.users?.length > 1
                          ? "haben reagiert"
                          : "hat reagiert"
                      }}
                    </div>
                  </div>
                  {{ emojis.emoji }}
                  <div>
                    {{ emojis.count }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="emoji-cont">
            <emoji-mart
              class="emoji-mart"
              *ngIf="showEmojiPicker[i]"
              (emojiSelect)="addEmojiAnswer($event, i)"
              size="25%"
              title="Pick your emoji…"
            ></emoji-mart>
          </div>
          <div class="message-members-answers" *ngIf="!currentChatData">
            <span
              *ngIf="message.answers?.length > 0"
              class="font400-normal"
              (click)="openThread(i, message.id)"
              >{{ message.answers?.length }} Antworten</span
            >
            <a *ngIf="message.answers.length > 0" class="font400-normal"
              >Letzte Antwort: {{ getLastAnswerTime(message) }}
            </a>
          </div>
        </div>
        <div class="editMessage" *ngIf="editMessageUser[i]">
          <input
            type="text"
            placeholder="{{ message.text }}"
            [(ngModel)]="editedMessageUser"
          />
          <div class="editMessage-buttons">
            <div class="editMessage-cancel" (click)="closeEdit(i)">
              <span>Abbrechen</span>
            </div>
            <div class="editMessage-save" (click)="saveEditMessage(i)">
              <span>Speichern</span>
            </div>
          </div>
        </div>
      </div>
      <!-- </ng-container> -->
    </div>
  </div>
</div>
<!-- </div> -->

<!--Container to write in chat-->
<div class="message-box-cont" *ngIf="messageBox">
  <div class="message-box" [class.focused]="taIsFocused">
    <div *ngIf="userChannel" class="containerSearchChat">
      <div *ngFor="let member of searchResults">
        <span (click)="insertName(member)" style="color: blue">{{
          member.name
        }}</span>
      </div>
    </div>

    <textarea
      class="font400-normal auto-resizable-textarea"
      placeholder="{{ placeholderMessageBox }}"
      (input)="onTextareaInput($event)"
      [(ngModel)]="message"
      (focus)="inputFocused()"
      (focus)="textAreaFocused()"
      (blur)="textAreaBlurred()"
      #messageTextarea
    ></textarea>
    <div
      class="image-preview-cont"
      #imagePreviewCont
      [style.display]="imageLoaded ? 'block' : 'none'"
    >
      <img id="image-preview" #imagePreview />
      <div (click)="removeFileSelected()"></div>
    </div>

    <div class="send-mesg-box">
      <div class="send-msg-icons">
        <div class="icon-plus icons" (click)="fileInput.click()">
          <input
            type="file"
            (change)="onFileSelected($event)"
            #fileInput
            style="display: none"
          />
          <div></div>
        </div>
        <div class="icons-line"></div>
        <div class="icon-s icons" (click)="toggleEmojiPicker(-2)">
          <div></div>
        </div>
        <div>
          <emoji-mart
            class="emoji-mart"
            *ngIf="showEmojiPicker[-2]"
            (emojiSelect)="addEmoji($event)"
            title="Pick your emoji…"
          ></emoji-mart>
        </div>
        <div class="icon-et icons" (click)="writeUser()">
          <div></div>
        </div>
      </div>

      <div
        class="send-msg"
        *ngIf="sendChannel"
        (click)="sendChannelMsg()"
      ></div>
      <div
        class="send-msg"
        *ngIf="sendPrivate"
        (click)="sendPrivateMsg()"
      ></div>
    </div>
  </div>
</div>
